name: Auto-Manage Labels

on:
  issues:
    types: [opened, labeled, unlabeled]
  workflow_dispatch:

jobs:
  setup-labels:
    runs-on: ubuntu-latest
    name: Create Default Labels
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Create Labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const labels = [
              // Difficulty levels
              {
                name: 'easy',
                color: '0E8A16',
                description: 'Good for beginners - minimal complexity'
              },
              {
                name: 'medium',
                color: 'FBC209',
                description: 'Moderate difficulty - some complexity'
              },
              {
                name: 'hard',
                color: 'D73A49',
                description: 'High difficulty - significant complexity'
              },
              // Priority levels
              {
                name: 'priority-critical',
                color: 'E11D21',
                description: 'Must be fixed immediately'
              },
              {
                name: 'priority-high',
                color: 'EB6420',
                description: 'High priority issue'
              },
              {
                name: 'priority-medium',
                color: 'FBB81C',
                description: 'Medium priority issue'
              },
              {
                name: 'priority-low',
                color: '0366D6',
                description: 'Low priority - can wait'
              },
              // Types
              {
                name: 'bug',
                color: 'D73A49',
                description: 'Something is broken'
              },
              {
                name: 'feature',
                color: '1F883D',
                description: 'New feature request'
              },
              {
                name: 'enhancement',
                color: '1F883D',
                description: 'Improvement to existing feature'
              },
              {
                name: 'documentation',
                color: '0075CA',
                description: 'Documentation update'
              },
              {
                name: 'performance',
                color: '5319E7',
                description: 'Performance improvement'
              },
              {
                name: 'refactor',
                color: '9E5A96',
                description: 'Code refactoring'
              },
              {
                name: 'security',
                color: 'EE3B3B',
                description: 'Security vulnerability'
              },
              {
                name: 'testing',
                color: '7057FF',
                description: 'Test-related changes'
              },
              // Status
              {
                name: 'good-first-issue',
                color: '7057FF',
                description: 'Great starting point for new contributors'
              },
              {
                name: 'help-wanted',
                color: '008672',
                description: 'Help needed from community'
              },
              {
                name: 'assigned',
                color: '0366D6',
                description: 'Issue is assigned to someone'
              },
              {
                name: 'in-progress',
                color: 'E2E3E8',
                description: 'Actively being worked on'
              },
              {
                name: 'on-hold',
                color: 'E2E3E8',
                description: 'Blocked or waiting'
              },
              {
                name: 'needs-review',
                color: 'FBB81C',
                description: 'Waiting for review'
              },
              {
                name: 'blocked',
                color: 'E11D21',
                description: 'Blocked by another issue'
              },
              {
                name: 'duplicate',
                color: 'CCCCCC',
                description: 'Duplicate of another issue'
              },
              {
                name: 'wontfix',
                color: 'CCCCCC',
                description: 'Will not be fixed'
              },
              {
                name: 'question',
                color: 'D876E3',
                description: 'Question or discussion'
              },
              // Areas
              {
                name: 'area-api-gateway',
                color: '1F883D',
                description: 'Related to API Gateway'
              },
              {
                name: 'area-workers',
                color: '1F883D',
                description: 'Related to Worker services'
              },
              {
                name: 'area-database',
                color: '1F883D',
                description: 'Related to Database layer'
              },
              {
                name: 'area-auth',
                color: '1F883D',
                description: 'Related to Authentication'
              },
              {
                name: 'area-deployment',
                color: '1F883D',
                description: 'Related to Deployment system'
              },
              {
                name: 'area-infrastructure',
                color: '1F883D',
                description: 'Related to Infrastructure'
              }
            ];
            
            for (const label of labels) {
              try {
                // Try to create the label
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name,
                  color: label.color,
                  description: label.description
                });
                console.log(`‚úÖ Created label: ${label.name}`);
              } catch (error) {
                // Label might already exist, try to update it
                if (error.status === 422) {
                  try {
                    await github.rest.issues.updateLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      name: label.name,
                      color: label.color,
                      description: label.description
                    });
                    console.log(`‚úèÔ∏è  Updated label: ${label.name}`);
                  } catch (updateError) {
                    console.log(`‚ö†Ô∏è  Could not update label ${label.name}: ${updateError.message}`);
                  }
                } else {
                  console.log(`‚ö†Ô∏è  Could not create label ${label.name}: ${error.message}`);
                }
              }
            }

  validate-new-issue-labels:
    runs-on: ubuntu-latest
    name: Guide Label Usage
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Suggest Labels for New Issues
        uses: actions/github-script@v7
        if: github.event.action == 'opened'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            
            // If no labels, suggest some
            if (issue.labels.length === 0) {
              github.rest.issues.createComment({
                issue_number: issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `üëã **Welcome!** Please add relevant labels to help us categorize this issue:\n\n**Difficulty:** \`easy\` | \`medium\` | \`hard\`\n**Type:** \`bug\` | \`feature\` | \`documentation\` | \`enhancement\`\n**Priority:** \`priority-critical\` | \`priority-high\` | \`priority-medium\` | \`priority-low\`\n**Status:** \`good-first-issue\` | \`help-wanted\` | \`needs-review\`\n\nMaintainers will help add appropriate labels as well!`
              });
            }
